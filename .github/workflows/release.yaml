name: Release macOS Build

on:
  push:
    branches: [main]  # Change to your release branch
    tags:
      - 'v*'

jobs:
  build-release:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        profile: minimal
        override: true

    - name: Set version from Git tag
      id: set-version
      run: |
        echo "VERSION=${GITHUB_REF/refs\/tags\//}" >> $GITHUB_ENV

    - name: Install cargo-bundle
      run: cargo install cargo-bundle

    - name: Build release bundle
      run: cargo bundle --release

    - name: Zip the .app bundle
      run: |
        cd target/release/bundle/osx
        zip -r "drum_gen_template_editor-${{ env.VERSION }}.zip" "DrumGen Template Editor.app"
        mv "drum_gen_template_editor-${{ env.VERSION }}.zip" ../../../

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: "v${{ env.VERSION }}"
        tag_name: "${{ env.VERSION }}"
        files: "drum_gen_template_editor-${{ env.VERSION }}.zip"  # Corrected the file path here
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}